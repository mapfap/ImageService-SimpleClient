<!DOCTYPE html>

<html lang="en">
  <head>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="jquery-1.11.0.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <title>Image Service | Playground</title>
  </head>
  <body>

    <a href="https://github.com/mapfap/ImageService"><img style="position: absolute; top: 0; right: 0; border: 0;" src="github.png" alt="Fork me on GitHub"></a>
    
    <div class="header">
      <h1> Image Service | Playground </h1>
      by mapfap
    </div>

    <div class="panel panel-primary">
      <div class="panel-heading">
        <h3 class="panel-title">Upload Image</h3>
      </div>
      <div class="panel-body">
        <form method='post' enctype="multipart/form-data">

              <input id="file" type='file' name='file' />
        </form>
      </div>
    </div>

    <div class="panel panel-primary">
      <div class="panel-heading">
        <h3 class="panel-title">Get Image</h3>
      </div>
      <div class="panel-body">
        <div class="input-group">
          <input type="text" class="form-control url">
          <span class="input-group-btn">
            <button class="btn btn-primary" type="button" id="get">GET</button>
          </span>
        </div>
        <button class="btn btn-default toggle-options" type="button">Show/Hide Options</button>
        <div class="options">
          Width <input type="range" name="width" min="-500" max="500">
          Height <input type="range" name="height" min="-500" max="500">
          Brightness <input type="range" name="brightness" min="-5" max="5">
          <input type="checkbox" name="grayscale" value="Bike"> Grayscale
          <br>
          <input type="checkbox" name="gaussian" value="Bike"> Gaussian Blur

        </div>
        
        <div class="show">

        </div>
      </div>
    </div>

    <div class="panel panel-primary">
      <div class="panel-heading">
        <h3 class="panel-title">Images Listing for Admin</h3>
      </div>
      <div class="panel-body">
        <button id="list" class="btn btn-primary">
          Show
        </button>
        <div class="show-list">
        </div>
      </div>
    </div>
    
    <div class="modal"></div>

  </body>

  <script>
    $(function() {

      // var IMAGE_SERVICE = "http://mapfap.tk/images";
      var IMAGE_SERVICE = "http://localhost:8080/images";

      $("#list").click(function(e) {
        $.get(IMAGE_SERVICE, function(xml) {
          var html = "";
          $(xml).find('entry').each(function(){
            var link = $(this).find('link').attr("href");
            console.log(link);
            html += "<li>" + link + "<!--br><img src='" + link + "'--></li>";
          });
          $(".show-list").html(html);
        });
      });

      function getImage(url) {
        // $.get(url, function(response) {
          $(".show").html("<img src='" + url + "'>");
        // });
      }

      $(".url").change(function(e) {
        getImage($(".url").val());
      });

      $("#get").click(function(e) {
        getImage($(".url").val());
      });

      function postFile() {
        var formData = new FormData($('form')[0]);
        $.ajax({
          url: IMAGE_SERVICE,  //Server script to process data
          type: "POST",
          xhr: function() {  // Custom XMLHttpRequest
              var myXhr = $.ajaxSettings.xhr();
              if (myXhr.upload) { // Check if upload property exists
                  // myXhr.upload.addEventListener("progress", progressHandlingFunction, false); // For handling the progress of the upload
              }
              return myXhr;
          },
          //Ajax events
          beforeSend: function(res) { 
            // console.log(res)
          },
          success: function(data, textStatus, jqXHR) {
            // console.log(res.getResponseHeader("location"));
            var location = jqXHR.getResponseHeader("location");
            $(".url").val(location);
            // getImage(location);

          },
          error: function(data, textStatus, jqXHR) {
            console.log(textStatus)
          },
          // Form data
          data: formData,
          //Options to tell jQuery not to process data or worry about content-type.
          cache: false,
          contentType: false,
          processData: false
      });
      }

      $("#file").change(function () {
        if ($("#file").val() == "") {
          return;
        }

        postFile();

        $("#file").val("");
      });

      $(document).on({
        ajaxStart: function() {
          // if (showLoading) {
            $("body").addClass("loading");
          // }
        },
        ajaxStop: function() {
          $("body").removeClass("loading");
        }    
      });

      $(".toggle-options").click(function(e) {
        $(".options").slideToggle();
      });
    });
  </script>
</html>